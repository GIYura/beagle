#### Accelerometer (ADXL345)

##### Connection

1. Pinout

| ADXL345  | BBB     | Notes      |
|----------|---------|------------|
|  GND     |  P9.1   |  GND       |
|  VCC     |  P9.3   |  3.3V      |
|  CS      |  P9.17  |  spi0_cs0  |
|  SCL     |  P9.22  |  spi0_sclk |
|  SDA     |  P9.18  |  spi0_d1   |
|  SDO     |  P9.21  |  spi0_d0   |

##### HOST

1. Compile application:
```
make
```

2. Transfer application to the target:
```
make copy-app
```

##### TARGET

1. Edit /boot/uEnv.txt:

- enable overlays:
```
enable_uboot_overlays=1
```

- enable SPI0 bus:
```
uboot_overlay_addr6=/lib/firmware/BB-SPIDEV0-00A0.dtbo
```

2. Run application:
```
sudo ./adxl345-app
```

##### Обзор SPI в Linux

Драйверы SPI в Linux делятся на две части. 
Первая — это драйверы SPI контроллеров, которые работают непосредственно с железом конкретно взятого контроллера. 
Такие драйверы определяют как настроить контроллер, какие действия предпринять при переходе в режим пониженного энергопотребления (suspend) и выходе из него(resume), 
выбор следующей передачи (spi_transfer) из очереди передач в сообщении и отправка его непосредственно в порт, также определяется как активировать/деактивировать конкретное 
устройство посредством CS (функции cs_activate/cs_deactivate). 

Вторая часть — это протокольные драйверы, используемые для работы с различными ведомыми устройствами, которые подключены к шине SPI. Данные драйверы называют «протокольными», 
потому что они лишь отправляют и получают различные данные от ведомых устройств, при этом не работая напрямую с каким-либо оборудованием. 

Большинство протокольных драйверов представляет собой модули ядра. 

Также ядро предоставляет протокольный драйвер общего назначения, называемый spidev, с интерфейсом в виде символьного устройства. 
Он позволяет совершать полудуплексные обращения к ведомому SPI-устройству посредством стандартных системных вызовов read() и write(), устанавливать режим работы, 
а также производить полнодуплексный обмен данными посредством ioctl() вызовов.

Таким образом протокольные драйверы для SPI устройств можно разделить на два типа:

 - userspace драйверы, работающие в пространстве пользователя и представляющие собой обычные программы на любом языке, работающие с SPI устройством посредством 
чтения/записи соответствующего символьного устройства spidev.

- драйверы, работающие в пространстве ядра и предоставляющие интерфейс для userspace посредством файлов устройств в каталоге /dev, либо с помощью атрибутов в каталоге 
устройства в sysfs.

Все обращения к SPI устройствам Linux ставит в очередь. Протокольные драйверы SPI оперируют явно или не явно сообщениями представленными структурой struct spi_message, 
которая является мультисегментной SPI транзакцией.

**ВАЖНО:** При инициализации структуры spi_transfer существует очень важный момент, они обязательно должны быть выделены в области памяти доступной для DMA через kmalloc,
kzalloc и иже с ними. Если master-драйер использует dma, то при использовании статически объявленных массивов драйвер будет падать при попытке передачи.

Практически все поля структуры spi_ioc_transfer соответствуют полям структуры spi_transfer. Буферы данных предварительно я в/из пространства ядра с помощью функций 
copy_from_user()/copy_to_user() в недрах драйвера spidev.

